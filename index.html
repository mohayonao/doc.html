<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>doc.html</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
  <script src="//cdn.jsdelivr.net/es6-promise/1.0.0/promise.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
</head>
<body>
  <div class="container">
    <div id="contents"></div>
    <div class="text-center" style="margin:10px 0;font-size:0.8em">
      Generated by <a href="https://github.com/mohayonao/doc.html">doc.html v0.1.0</a> by <a href="https://github.com/mohayonao">@mohayonao</a>
    </div>
  </div>
  <script>
  window.fetch = window.fetch || function(url) {
    return new Promise(function(resolve, reject) {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", url);
      xhr.onload = function() {
        resolve({
          text: function() {
            return Promise.resolve(xhr.response);
          },
          json: function() {
            return Promise.resolve(JSON.parse(xhr.response));
          }
        });
      };
      xhr.onerror = reject;
      xhr.send();
    });
  };
  window.onload = function() {
    "use strict";

    var docIndex = [
      // "package.json",
      "README.md",
      "src/ftom.js",
      "src/mtof.js",
    ];

    marked.setOptions({
      renderer: (function() {
        var renderer = new marked.Renderer();

        renderer.code = function(code) {
          return "<pre class='prettyprint'>" + code + "</pre>";
        };

        return renderer;
      })(),
    });

    function mdFromPackageJSON(text) {
      var pkg = JSON.parse(text);

      return [
        "# " + pkg.name,
        pkg.description || ""
      ].join("\n");
    }

    function mdFromSourceCode(text, ext) {
      var re = /^\/\/\s*(.*)$/;

      return text.split("\n").map(function(line) {
        return re.exec(line);
      }).filter(function(m) {
        return !!m;
      }).map(function(m) {
        return m[1];
      }).join("\n");
    }

    function flatten(array) {
      return Array.prototype.concat.apply([], array);
    };

    Promise.resolve(docIndex).then(function(documentIndex) {
      return Promise.all(documentIndex.map(function(path) {
        return fetch(path).then(function(res) {
          return res.text();
        }).then(function(text) {
          if (/package\.json$/.test(path)) {
            text = mdFromPackageJSON(text);
          } else if (!/\.md$/.test(path)) {
            var ext = /\.(\w+)$/.exec(path);
            text = mdFromSourceCode(text, ext && ext[1]);
          }
          return text;
        });
      })).then(function(docs) {
        flatten(docs.map(function(doc) {
          var div = document.createElement("div");

          div.innerHTML = marked(doc);

          return [ div, document.createElement("hr") ];
        })).forEach(function(elem) {
          document.getElementById("contents").appendChild(elem);
        });
      });
    }).then(prettyPrint);
  };
  </script>
</body>
</html>
